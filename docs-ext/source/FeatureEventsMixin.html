<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='CpsiMapview-model-FeatureEventsMixin'>/**
</span> * A model mixin that keeps map layers in sync with related models.
 * Any associated WMS layer or WFS layer that contains the updated
 * feature is automatically refreshed.
 * In addition the model is saved a `modelsaved` event is fired to allow for custom hooks.
 *
 * Example configuration settings on a model:
 *
 *  syncLayerKeys: [&#39;LAYER1_KEY_WMS&#39;, &#39;LAYER2_KEY_WMS&#39;]  // associated WMS layers
 *  syncStoreIds: [&#39;GridStore1&#39;, &#39;GridStore2&#39;] // associated grid store aliases
 *
 */
Ext.define(&#39;CpsiMapview.model.FeatureEventsMixin&#39;, {
    requires: [
        &#39;Ext.data.proxy.Rest&#39;, // without this the production apps don&#39;t work
        &#39;CpsiMapview.util.Layer&#39;
    ],
    extend: &#39;Ext.Mixin&#39;,

    mixins: {
        observable: &#39;Ext.util.Observable&#39;
    },

<span id='CpsiMapview-model-FeatureEventsMixin-property-mixinConfig'>    mixinConfig: {
</span>        on: {
            constructor: function () {
                // Ext.mixin.Observable requires the constructor to be called
                // https://docs.sencha.com/extjs/6.7.0/classic/Ext.mixin.Observable.html
                this.mixins.observable.constructor.call(this);
            }
        },
        before: {
            save: &#39;onSave&#39;
        }
    },

<span id='CpsiMapview-model-FeatureEventsMixin-method-onModelSaved'>    /**
</span>     * When the model is saved refresh any layers that are linked to the model
     * Note this will also be fired when a model is successfully deleted
     * */
    onModelSaved: function () {
        var me = this;
        var layerUtil = CpsiMapview.util.Layer;

        // update associated layers
        Ext.each(me.syncLayerKeys, function (k) {
            var layers = BasiGX.util.Layer.getLayersBy(&#39;layerKey&#39;, k);
            if (layers.length &gt; 0) {
                var layer = layers[0];
                layerUtil.layerRefresh(layer);
            }
        });

        // update associated WFS stores (grid stores)
        Ext.each(me.syncStoreIds, function (k) {
            var store = Ext.data.StoreManager.lookup(k);
            if (store) {
                store.reload();
            }
        });

        me.fireEvent(&#39;modelsaved&#39;);
    },

<span id='CpsiMapview-model-FeatureEventsMixin-method-onSave'>    /**
</span>     * Add the mixin `onModelSaved` function to any save success callbacks
     * */
    onSave: function (options) {
        var me = this;

        if (options.success) {
            // last parameter sets the scope for the additional function
            options.success = Ext.Function.createSequence(options.success, me.onModelSaved, me);
        } else {
            options.success = me.onModelSaved;
        }
    }
});
</pre>
</body>
</html>
