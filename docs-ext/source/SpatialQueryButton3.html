<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='CpsiMapview-controller-button-SpatialQueryButtonController'>/**
</span>* This class is the controller for the button &#39;SpatialQueryButton&#39;
 */
Ext.define(&#39;CpsiMapview.controller.button.SpatialQueryButtonController&#39;, {
    extend: &#39;Ext.app.ViewController&#39;,

    alias: &#39;controller.cmv_spatial_query_btn&#39;,

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-property-drawQueryInteraction'>    /**
</span>     * The {ol.interaction.Draw} used to draw the geometry used in the spatial
     * query
     * @property{ol.interaction.Draw}
     */
    drawQueryInteraction: null,

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-property-modifiyQueryInteraction'>    /**
</span>     * The {ol.interaction.Modify} used to modify the geometry used in the spatial
     * query
     * @property{ol.interaction.Modify}
     */
    modifiyQueryInteraction: null,

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-property-snapQueryInteraction'>    /**
</span>     * The {ol.interaction.Snap} used to snap to the points of the geometry used
     * in the spatial query
     * @property{ol.interaction.Snap}
     */
    snapQueryInteraction: null,

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-property-permanentLayer'>    /**
</span>     * The layer that contains the geometry used in the spatial query, if
     * displayPermanently is set to true
     * @property{ol.layer.Vector}
     */
    permanentLayer: null,

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-property-permanentLayerCreatedByTool'>    /**
</span>     * Flag indicating if the layer was created directly by the tool or
     * is an existing layer passed as a configuration option
     * @property {boolean}
     */
    permanentLayerCreatedByTool: false,

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-property-map'>    /**
</span>    * The OpenLayers map. If not given, will be auto-detected
    */
    map: null,

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-property-mapComponent'>    /**
</span>     * The BasiGX mapComponent. If not given, will be auto-detected
     */
    mapComponent: null,


<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-constructor'>    constructor: function () {
</span>        var me = this;
        me.getFeaturesFromSourceAndTriggerWfs = me.getFeaturesFromSourceAndTriggerWfs.bind(me);
        me.getGeometryFromPolygonAndTriggerWfs = me.getGeometryFromPolygonAndTriggerWfs.bind(me);
        me.onQueryLayerVisibilityChange = me.onQueryLayerVisibilityChange.bind(me);
        me.callParent(arguments);
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-findQueryLayer'>    /**
</span>     * Function to determine the query layer if not yet defined in class
     */
    findQueryLayer: function () {
        var me = this;
        var view = me.getView();
        if (!view.queryLayer &amp;&amp; view.queryLayerName) {
            view.queryLayer = BasiGX.util.Layer.
                getLayerByName(view.queryLayerName);
        }

        if (!view.queryLayer) {
            Ext.Logger.warn(&#39;No queryLayer found in the map for the SpatialQueryButton with the name: &#39; + view.queryLayerName);
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onSpatialQueryBtnToggle'>    /**
</span>     * Activates #drawQueryInteraction on button toggle to draw polygon
     * selection geometry that will be used for filtering.
     *
     * @param {Ext.button.Button} btn The toggled select by polygon button.
     * @param {Boolean} pressed The toggle state.
     */
    onSpatialQueryBtnToggle: function (btn, pressed) {
        var me = this;
        var view = me.getView();

        if (view.map &amp;&amp; view.map instanceof ol.Map) {
            me.map = view.map;
        } else {
            // guess map as fallback
            me.map = BasiGX.util.Map.getMapComponent().map;
        }

        if (!view.queryLayer) {
            me.findQueryLayer();
        }

        var geometryFunction;
        var type = view.drawGeometryType;
        if (view.spatialOperator === &#39;bbox&#39;) {
            type = &#39;Circle&#39;;
            geometryFunction = ol.interaction.Draw.createBox();
        }

        var vectorLayerKey = view.getVectorLayerKey();
        me.permanentLayer = CpsiMapview.view.button.SpatialQueryButton.findAssociatedPermanentLayer(me.map, vectorLayerKey);
        if (me.permanentLayer === undefined) {
            me.permanentLayerCreatedByTool = true; // add flag indicating the tool will handle the destruction of the layer
            me.permanentLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
            me.permanentLayer.set(&#39;associatedLayerKey&#39;, vectorLayerKey);
            me.permanentLayer.set(&#39;isSpatialQueryLayer&#39;, true);
            me.permanentLayer.set(&#39;name&#39;, vectorLayerKey + &#39;_spatialfilter&#39;);
            // connect hide and show to query layer hide and show
            me.connectQueryLayer();
        }

        var permanentLayerSource = me.permanentLayer.getSource();
        if (!me.drawQueryInteraction) {
            if (view.displayPermanently) {
                me.map.addLayer(me.permanentLayer);
                me.drawQueryInteraction = new ol.interaction.Draw({
                    source: permanentLayerSource,
                    geometryFunction: geometryFunction,
                    type: type
                });

                me.modifiyQueryInteraction = new ol.interaction.Modify({
                    source: permanentLayerSource
                });
                me.snapQueryInteraction = new ol.interaction.Snap({
                    source: permanentLayerSource
                });
                me.map.addInteraction(me.modifiyQueryInteraction);
                me.map.addInteraction(me.snapQueryInteraction);
            } else {
                me.drawQueryInteraction = new ol.interaction.Draw({
                    features: view.queryFeatures,
                    geometryFunction: geometryFunction,
                    type: type
                });
            }
            me.map.addInteraction(me.drawQueryInteraction);
        }
        if (pressed) {
            me.drawQueryInteraction.setActive(true);
            me.map.getViewport().addEventListener(&#39;contextmenu&#39;, me.contextHandler);
            if (view.displayPermanently) {
                me.modifiyQueryInteraction.setActive(true);
                me.snapQueryInteraction.setActive(true);
                me.drawQueryInteraction.on(&#39;drawend&#39;, me.getFeaturesFromSourceAndTriggerWfs);
                me.modifiyQueryInteraction.on(&#39;modifyend&#39;, me.getFeaturesFromSourceAndTriggerWfs);
            } else {
                view.queryFeatures.on(&#39;add&#39;, me.getGeometryFromPolygonAndTriggerWfs);
            }
        } else {
            me.drawQueryInteraction.setActive(false);
            me.map.getViewport().removeEventListener(&#39;contextmenu&#39;, me.contextHandler);
            if (view.displayPermanently) {
                me.modifiyQueryInteraction.setActive(false);
                me.snapQueryInteraction.setActive(false);
                me.drawQueryInteraction.un(&#39;drawend&#39;, me.getFeaturesFromSourceAndTriggerWfs);
                me.modifiyQueryInteraction.un(&#39;modifyend&#39;, me.getFeaturesFromSourceAndTriggerWfs);
            } else {
                view.queryFeatures.un(&#39;add&#39;, me.getGeometryFromPolygonAndTriggerWfs);
            }
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-showContextMenu'>    /**
</span>     * Method shows the context menu on mouse right click
     * @param {Event} evt The browser event
     */
    showContextMenu: function (evt) {
        // suppress default browser behaviour
        evt.preventDefault();

        var me = this.scope;

        var menu = Ext.create(&#39;Ext.menu.Menu&#39;, {
            width: 100,
            plain: true,
            renderTo: Ext.getBody(),
            items: [{
                text: &#39;Clear Feature&#39;,
                handler: function () {
                    var view = me.getView();
                    // remove the spatial filter on the layer by firing an event
                    view.fireEvent(&#39;cmv-spatial-query-filter&#39;, null);
                    // now remove the polygon from the layer
                    me.onClearAssociatedPermanentLayer();
                },
                scope: me
            }]
        });
        menu.showAt(evt.pageX, evt.pageY);
    },
<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-connectQueryLayer'>    /**
</span>     * Connects the change:visible event of the query layer
     * to the permanent layer. Thereby, when the query layer
     * visibility is changed, the visibility of the permanent layer
     * changes accordingly.
     */
    connectQueryLayer: function () {
        var me = this;
        var view = me.getView();
        var layerKey = view.getVectorLayerKey();
        if (!layerKey) {
            return;
        }
        if (view.queryLayer) {
            view.queryLayer.on(&#39;change:visible&#39;, me.onQueryLayerVisibilityChange);
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onQueryLayerVisibilityChange'>    /**
</span>     * Event handler for the change:visible event of the
     * query layer.
     * @param {ol.Object.event} evt change:visible event of layer
     */
    onQueryLayerVisibilityChange: function (evt) {
        var me = this;
        var visible = evt.target.getVisible();
        if (visible) {
            me.onShowAssociatedPermanentLayer();
        } else {
            me.onHideAssociatedPermanentLayer();
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-createSpatialFilter'>    /**
</span>    * Creates a Filter object from the passed geometry and queryLayer
    *
    * @param  {ol.geom.Geometry} geometry The geometry
    * @return {Ext.util.Filter}       A filter spatial
    * @private
    */
    createSpatialFilter: function (geometry) {
        var me = this;
        var filter = null;

        var view = me.getView();
        if (!view.queryLayer) {
            return;
        }

        var mapComp = me.mapComponent || BasiGX.util.Map.getMapComponent();
        var projString = mapComp.getMap().getView().getProjection().getCode();
        var geomFieldName = view.queryLayer.get(&#39;geomFieldName&#39;) ||
            view.queryLayer.getSource().get(&#39;geomFieldName&#39;) ||
            &#39;the_geom&#39;;

        if (!Ext.isEmpty(geometry)) {
            filter = GeoExt.util.OGCFilter.createSpatialFilter(view.spatialOperator, geomFieldName, geometry, projString);
        }

        return filter;

    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-getFeaturesFromSourceAndTriggerWfs'>    /**
</span>     * Handles the modifyend and drawend events of the draw layer
     * @param {ol.Object.event} evt ol modifyend or drawend event
     */
    getFeaturesFromSourceAndTriggerWfs: function (evt) {
        var me = this;
        var feature;
        if (evt.type === &#39;modifyend&#39;) {
            // We expect to only have one existing feature in source.
            // In case multiple features exist, we only use the one
            // that was added last
            feature = evt.features.getArray()[evt.features.getLength() - 1];
        } else if (evt.type === &#39;drawend&#39;) {
            // clear previously drawn features so that only one feature exists
            me.permanentLayer.getSource().clear();
            feature = evt.feature;
        }
        var fakeEvent = { element: feature };
        me.getGeometryFromPolygonAndTriggerWfs(fakeEvent);
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-getGeometryFromPolygonAndTriggerWfs'>    /**
</span>     * Helper method to create a polygon geometry from drawn irregular polygon.
     *
     * @param {Ext.Event} evt The add-Event containing drawn feature
     */
    getGeometryFromPolygonAndTriggerWfs: function (evt) {
        var me = this;
        var geometry = evt.element.getGeometry();
        var view = me.getView();

        var filter = me.createSpatialFilter(geometry);
        view.fireEvent(&#39;cmv-spatial-query-filter&#39;, filter);
        if (view.triggerWfsRequest === true) {
            this.buildAndRequestQuery(geometry);
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-buildAndRequestQuery'>    /**
</span>     * Build query / filter and call WFS
     *
     * @param {ol.geom.Geometry} geometry The geometry
     */
    buildAndRequestQuery: function (geometry) {
        var me = this;
        var view = me.getView();
        if (!view.queryLayer) {
            return;
        }

        var mapComp = me.mapComponent || BasiGX.util.Map.getMapComponent();

        var projString = mapComp.getMap().getView().getProjection().getCode();
        var geomFieldName = view.queryLayer.get(&#39;geomFieldName&#39;) ||
            view.queryLayer.getSource().get(&#39;geomFieldName&#39;) ||
            &#39;the_geom&#39;;
        var url = view.queryLayer.get(&#39;url&#39;) ||
            view.queryLayer.getSource().getUrl() ||
            view.queryLayer.getSource().getUrls()[0];

        var featureType = view.queryLayer.get(&#39;featureType&#39;) ||
            BasiGX.util.Object.layersFromParams(
                view.queryLayer.getSource().getParams()
            );

        if (!Ext.isEmpty(geometry)) {
            var filter = GeoExt.util.OGCFilter.getOgcFilter(
                geomFieldName, view.spatialOperator, geometry, &#39;1.1.0&#39;, projString);

            mapComp.setLoading(true);
            BasiGX.util.WFS.executeWfsGetFeature(
                url,
                view.queryLayer,
                projString,
                null,
                geomFieldName,
                filter,
                null,
                me.onWfsExecuteSuccess,
                me.onWfsExecuteFailure,
                me,
                null,
                featureType
            );
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onWfsExecuteSuccess'>    /**
</span>     * Handle a successful WFS request.
     *
     * @param {XMLHttpRequest.response} response The response of the AJAX call.
     */
    onWfsExecuteSuccess: function (response) {
        var me = this;
        var view = me.getView();
        var mapComp = me.mapComponent || BasiGX.util.Map.getMapComponent();
        mapComp.setLoading(false);
        var wfsResponse = response.responseText;
        if (wfsResponse.indexOf(&#39;Exception&#39;) &gt; 0) {
            // something got wrong and we probably have an exception, that we
            // try to handle...
            BasiGX.util.WFS.handleWfsExecuteException(wfsResponse);
            view.fireEvent(&#39;cmv-spatial-query-error&#39;, decodedResponse);
        } else {
            var decodedResponse = Ext.decode(wfsResponse);
            view.fireEvent(&#39;cmv-spatial-query-success&#39;, decodedResponse);
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onWfsExecuteFailure'>    /**
</span>     * Handle WFS GetFeature failure.
     *
     * @param {XMLHttpRequest.response} response The response of the AJAX call.
     */
    onWfsExecuteFailure: function (response) {
        var me = this;
        var view = me.getView();
        var responseTxt;
        if (response &amp;&amp; response.responseText) {
            responseTxt = response.responseText;
        }
        var mapComp = me.mapComponent || BasiGX.util.Map.getMapComponent();
        mapComp.setLoading(false);
        view.fireEvent(&#39;cmv-spatial-query-error&#39;, responseTxt);
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onClearAssociatedPermanentLayer'>    /**
</span>     * Handles clearing the permanentLayer of the instance.
     */
    onClearAssociatedPermanentLayer: function () {
        var me = this;
        var layerKey = me.getView().getVectorLayerKey();
        if (!me.map) {
            return;
        }
        if (!layerKey) {
            return;
        }
        CpsiMapview.view.button.SpatialQueryButton.clearAssociatedPermanentLayer(me.map, layerKey);
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onShowAssociatedPermanentLayer'>    /**
</span>     * Handles showing the permanentLayer of the instance.
     */
    onShowAssociatedPermanentLayer: function () {
        var me = this;
        var layerKey = me.getView().getVectorLayerKey();
        if (!me.map) {
            return;
        }
        if (!layerKey) {
            return;
        }
        CpsiMapview.view.button.SpatialQueryButton.showAssociatedPermanentLayer(me.map, layerKey);
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onHideAssociatedPermanentLayer'>    /**
</span>     * Handles hiding the permanentLayer of the instance.
     */
    onHideAssociatedPermanentLayer: function () {
        var me = this;
        var layerKey = me.getView().getVectorLayerKey();
        if (!me.map) {
            return;
        }
        if (!layerKey) {
            return;
        }
        CpsiMapview.view.button.SpatialQueryButton.hideAssociatedPermanentLayer(me.map, layerKey);
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-onBeforeDestroy'>    onBeforeDestroy: function () {
</span>        var me = this;
        var view = me.getView();

        // detoggle button
        me.onSpatialQueryBtnToggle(view, false);

        if (me.modifiyQueryInteraction) {
            me.map.removeInteraction(me.modifiyQueryInteraction);
        }

        if (me.snapQueryInteraction) {
            me.map.removeInteraction(me.snapQueryInteraction);
        }

        if (me.drawQueryInteraction) {
            me.map.removeInteraction(me.drawQueryInteraction);
        }

        if (me.permanentLayer &amp;&amp; me.permanentLayerCreatedByTool) {
            me.map.removeLayer(me.permanentLayer);
        }
    },

<span id='CpsiMapview-controller-button-SpatialQueryButtonController-method-init'>    init: function () {
</span>
        var me = this;

        // create an object for the contextmenu eventhandler
        // so it can be removed correctly
        me.contextHandler = {
            handleEvent: me.showContextMenu,
            scope: me
        };
    }
});
</pre>
</body>
</html>
