<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='CpsiMapview-controller-button-LoginButtonController'>/**
</span> * This class is the controller for the {@link CpsiMapview.view.button.LoginButton}
 */
Ext.define(&#39;CpsiMapview.controller.button.LoginButtonController&#39;, {
    extend: &#39;Ext.app.ViewController&#39;,

    requires: [
        &#39;CpsiMapview.view.form.Login&#39;
    ],

    alias: &#39;controller.cmv_login_button&#39;,

<span id='CpsiMapview-controller-button-LoginButtonController-property-displayRolePrefixes'>    /**
</span>    * The prefix used in the cookie for any browser-based
    * user roles
    * */
    displayRolePrefixes: [&#39;Browser_&#39;],

<span id='CpsiMapview-controller-button-LoginButtonController-method-onClick'>    /**
</span>     * Logout, clear the login cookie, and show
     * the login form
     * */
    onClick: function () {

        var app = Ext.getApplication ? Ext.getApplication() : Ext.app.Application.instance;
        var loginWin;

        if (app &amp;&amp; app.loginWindow) {
            loginWin = app.loginWindow;
        } else {
            var viewModel = {};
            if (app) {
                viewModel = {
                    tokenName: app.tokenName,
                    serviceUrl: app.authenticationUrl,
                    validateUrl: app.tokenValidationUrl,
                    minimumRequiredRole: app.minimumRequiredRole
                };
            }
            loginWin = Ext.create(&#39;CpsiMapview.view.form.Login&#39;, {
                viewModel: viewModel
            });
            if (app) {
                app.loginWindow = loginWin;
            }
        }
        loginWin.getController().logout();
        loginWin.show();
    },

<span id='CpsiMapview-controller-button-LoginButtonController-method-getLoginDetails'>    /**
</span>     * Get the user name and roles from the login cookie
     * and return as a formatted string
     * */
    getLoginDetails: function () {

        var me = this;
        var app = Ext.getApplication ? Ext.getApplication() : Ext.app.Application.instance;
        var userName = Ext.util.Cookies.get(&#39;username&#39;);
        var roles = Ext.util.Cookies.get(&#39;roles&#39;);
        var displayRolePrefixes = (app &amp;&amp; app.displayRolePrefixes) || me.displayRolePrefixes;
        if (roles) {
            roles = roles.split(&#39;,&#39;);
            var displayRoles = [];

            Ext.Array.each(roles, function (r) {
                Ext.Array.each(displayRolePrefixes, function (prefix) {
                    if (r.startsWith(prefix)) {
                        displayRoles.push(r.replace(prefix, &#39;&#39;));
                    }
                });
            });

            displayRoles.sort();
            roles = displayRoles.join(&#39;&lt;br /&gt;&#39;);
        }
        return Ext.String.format(&#39;Username: &lt;b&gt;{0}&lt;/b&gt;&lt;br /&gt;User Roles: &lt;br /&gt;&lt;br /&gt;{1}&#39;, userName, roles);
    },

<span id='CpsiMapview-controller-button-LoginButtonController-method-init'>    /**
</span>     * Init the controller and add listeners to the global
     * login and logout events fired by {@link CpsiMapview.controller.form.Login#login}
     * and {@link CpsiMapview.controller.form.Login#logout}
     * */
    init: function () {

        var me = this;

        Ext.GlobalEvents.on(&#39;login&#39;, function () {
            me.getViewModel().set(&#39;loggedIn&#39;, true);
        });

        Ext.GlobalEvents.on(&#39;logout&#39;, function () {
            me.getViewModel().set(&#39;loggedIn&#39;, false);
        });
    }

});
</pre>
</body>
</html>
