<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">Ext.define(&#39;CpsiMapview.plugin.FeatureAttributeGrouping&#39;, {
    extend: &#39;Ext.plugin.Abstract&#39;,
    alias: &#39;plugin.cmv_feature_attribute_grouping&#39;,
    pluginId: &#39;cmv_feature_attribute_grouping&#39;,

<span id='global-property-startGroupingEvent'>    /**
</span>     * can have the values &#39;move&#39; or &#39;click&#39;
     */
    startGroupingEvent: &#39;move&#39;,

<span id='global-property-endGroupingEvent'>    /**
</span>     * can have the values &#39;move&#39;, &#39;click&#39; or &#39;context&#39;
     * @property {string}
     */
    endGroupingEvent: &#39;move&#39;,

    initGrouping: function (mapCmp, olMap) {
        var me = this;

        this.mapCmp = mapCmp;
        this.olMap = olMap;

        this.layer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            map: olMap
        });

        var group = function (evt) {
            me.startGrouping(evt);
        };
        var ungroup = function () {
            me.endGrouping();
        };

        if (this.startGroupingEvent === &#39;move&#39;) {
            mapCmp.on(&#39;pointerrest&#39;, group);
        } else if (this.startGroupingEvent === &#39;click&#39;) {
            olMap.on(&#39;singleclick&#39;, group);
        }

        if (this.endGroupingEvent === &#39;move&#39;) {
            mapCmp.on(&#39;pointerrestout&#39;, ungroup);
            olMap.on(&#39;pointermove&#39;, ungroup);
        } else if (this.endGroupingEvent === &#39;click&#39;) {
            olMap.on(&#39;singleclick&#39;, ungroup);
        } else if (this.endGroupingEvent === &#39;context&#39;) {
            olMap.getViewport().addEventListener(&#39;contextmenu&#39;, function (e) {
                me.showContext(e);
            });
        }
    },

    startGrouping: function (evt) {
        var me = this;

        this.olMap.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
            me.endGrouping();

            var grouping = layer.get(&#39;grouping&#39;);

            me.layer.setStyle(me.getStyle(grouping));

            var features = layer.getSource().getFeatures()
                .filter(function (other) {
                    return other.get(grouping.attribute) === feature.get(grouping.attribute);
                });

            me.layer.getSource().addFeatures(features);
            me.groupingActive = true;
        }, {
            layerFilter: function (layer) {
                return layer.get(&#39;grouping&#39;);
            }
        });
    },

    endGrouping: function () {
        this.layer.getSource().clear();
        this.groupingActive = false;
    },

    getStyle: function (grouping) {
        return new ol.style.Style({
            image: new ol.style.Circle({
                radius: 10,
                stroke: new ol.style.Stroke({
                    color: grouping.strokeColor,
                    width: grouping.strokeWidth
                })
            }),
            stroke: new ol.style.Stroke({
                color: grouping.strokeColor,
                width: grouping.strokeWidth
            })
        });
    },

    showContext: function (evt) {
        var me = this;

        if (this.groupingActive) {
            evt.preventDefault();

            var menu = Ext.create(&#39;Ext.menu.Menu&#39;, {
                width: 160,
                plain: true,
                renderTo: Ext.getBody(),
                items: [{
                    text: &#39;Clear attribute grouping&#39;,
                    handler: function () {
                        me.endGrouping();
                    }
                }]
            });
            menu.showAt(evt.pageX, evt.pageY);
        }
    }
});
</pre>
</body>
</html>
