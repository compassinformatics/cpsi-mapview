<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: view/fileupload/FileUploadWindowController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: view/fileupload/FileUploadWindowController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>ï»¿/**
 * Controller for the window used to add new attachments
 *
 * File uploads are not performed using normal 'Ajax' techniques, that is they are
 * not performed using XMLHttpRequests.
 * Instead the form is submitted in the standard manner with the DOM &lt;form> element temporarily modified to have
 * its target set to refer to a dynamically generated, hidden &lt;iframe> which is inserted into the document but
 * removed after the return data has been gathered.
 * The server response is parsed by the browser to create the document for the IFRAME.
 * If the server is using JSON to send the return object, then the Content-Type header must
 * be set to 'text/html' in order to tell the browser to insert the text unchanged into the document body.
 *
 * Characters which are significant to an HTML parser must be sent as HTML entities,
 * so encode '&lt;' as '&amp;lt;', '&amp;' as '&amp;amp;' etc.
 *
 * The response text is retrieved from the document, and a fake XMLHttpRequest object is created containing a
 * responseText property in order to conform to the requirements of event handlers and callbacks.
 * Be aware that file upload packets are sent with the content type multipart/form and some server
 * technologies (notably JEE) may require some custom processing in order to retrieve parameter names
 * and parameter values from the packet content.
 *
 * @class CpsiMapview.view.fileupload.FileUploadWindowController
 */

Ext.define('CpsiMapview.view.fileupload.FileUploadWindowController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.cmv_fileuploadwindowcontroller',

    requires: [
        'CpsiMapview.model.fileupload.Attachment'
    ],

    getAttachmentUploadUrl: function () {

        var me = this;
        var parentRecord = me.getViewModel().getData().currentRecord;
        var serviceUrl = parentRecord.proxy.url;
        return Ext.String.format('{0}/{1}/attachment', serviceUrl, parentRecord.getId());
    },

    /**
     * Save the attachment to the server
     */
    onAttachmentSave: function () {

        var me = this;
        var form = me.getView().down('form');

        if (form.isValid()) {

            form.submit({
                clientValidation: true,
                url: me.getAttachmentUploadUrl(),
                waitMsg: 'Uploading your file...',
                scope: me,
                // the following is ignored for a form submission request
                // adding into an options object is also ignored
                headers: {
                    'Accept': 'application/json'
                },
                success: me.onSuccess,
                failure: me.onFailure
            });
        }
    },

    /**
     * Inform the user that the attachment was successfully uploaded and
     * trigger an event to the new record can be added to the attachments grid
     * TODO - return full object in response when saving
     * @param {any} form
     * @param {any} action
     */
    onSuccess: function (form, action) {

        var me = this;
        var formValues = form.getFieldValues();
        // create a new object containing the attributes of the attachment
        // after it was successfully associated
        // with the parent object. This record can then be added to a store

        var newAttachment = CpsiMapview.model.fileupload.Attachment.create({
            attachmentId: action.result.data.attachmentId,
            name: formValues.documentName,
            description: formValues.documentDescription,
            extension: 'Extension',
            fileName: formValues.filePath,
            fileSize: '',
            lastUpdatedDateUtc: Date(),
            isThumbnailAvailable: false
        });

        // now update the attachment URLs so it can be deleted
        var parentRecord = me.getViewModel().getData().currentRecord;
        var serviceUrl = parentRecord.proxy.url;
        newAttachment.updateAttachmentUrls(serviceUrl);

        // now show a message box to show the file was successfully uploaded

        var parentType = me.getViewModel().getData().parentType;
        var msg = Ext.String.format('The file {0} has been associated with the {1}', formValues.documentName, parentType);

        var vw = me.getView();
        Ext.Msg.alert('Success', msg, function () {
            vw.fireEvent('fileadded', newAttachment);
            vw.close();
        }, me);

    },

    /**
     * Alert the user the file was not successfully uploaded
     * JSON error messages are wrapped up in HTML
     * responseText: '&lt;pre style='word-wrap: break-word; white-space: pre-wrap;'>{'success':false,'message':'The cookie header with user token has not been provided.'}&lt;/pre>'
     * so get just the error message
     * relevant link http://stackoverflow.com/questions/18150134/response-of-a-submit-form-is-adding-pre-to-json
     *
     * The server response is parsed by the browser to create the document for the IFRAME.
     * If the server is using JSON to send the return object, then the Content-Type header
     * must be set to 'text/html' (on the server-side) in order to tell the browser to insert the text
     * unchanged into the document body.
     *
     * @param {any} form
     * @param {any} action
     */
    onFailure: function (form, action) {

        switch (action.failureType) {
            case Ext.form.Action.CLIENT_INVALID:
                Ext.Msg.alert('Failure', 'Form fields may not be submitted with invalid values');
                break;
            case Ext.form.Action.CONNECT_FAILURE:
                Ext.Msg.alert('Failure', 'Ajax communication failed');
                break;
            case Ext.form.Action.SERVER_INVALID:
                // the header for errors should be html/text
                // however 404 errors or non-JSON errors will produce a huge error box
                var txt = action.response.responseText;
                if (Ext.JSON.decode(txt, true) === null) {
                    // display any non-JSON errors
                    // JSON errors will be handled in CpsiMapview.util.ApplicationMixin
                    Ext.Msg.alert('Server Error', txt);
                }
                break;
            default:
                break;
        }
    },

    /**
     * Close the form on cancel
     * */
    onAttachmentCancelUpload: function () {
        this.getView().close();
    }
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CpsiMapview.controller.LayerTreeController.html">LayerTreeController</a></li><li><a href="CpsiMapview.controller.button.TracingMixin.html">TracingMixin</a></li><li><a href="CpsiMapview.controller.form.LayerTreeFilter.html">LayerTreeFilter</a></li><li><a href="CpsiMapview.controller.form.Login.html">Login</a></li><li><a href="CpsiMapview.controller.panel.NumericAttributeSlider.html">NumericAttributeSlider</a></li><li><a href="CpsiMapview.data.model.LayerTreeNode.html">LayerTreeNode</a></li><li><a href="CpsiMapview.factory.Layer.html">Layer</a></li><li><a href="CpsiMapview.form.ControllerMixin.html">ControllerMixin</a></li><li><a href="CpsiMapview.form.HelpMixin.html">HelpMixin</a></li><li><a href="CpsiMapview.form.LayersMixin.html">LayersMixin</a></li><li><a href="CpsiMapview.form.RightInfoField.html">RightInfoField</a></li><li><a href="CpsiMapview.form.ValidationMessagesMixin.html">ValidationMessagesMixin</a></li><li><a href="CpsiMapview.form.ViewMixin.html">ViewMixin</a></li><li><a href="CpsiMapview.form.ViewModelMixin.html">ViewModelMixin</a></li><li><a href="CpsiMapview.form.field.Combo.html">Combo</a></li><li><a href="CpsiMapview.form.field.ComboLegacy.html">ComboLegacy</a></li><li><a href="CpsiMapview.model.fileupload.Attachment.html">Attachment</a></li><li><a href="CpsiMapview.plugin.ExpandPanel.html">ExpandPanel</a></li><li><a href="CpsiMapview.plugin.FeatureAttributeGrouping.html">FeatureAttributeGrouping</a></li><li><a href="CpsiMapview.plugin.TreeColumnContextMenu.html">TreeColumnContextMenu</a></li><li><a href="CpsiMapview.store.WfsFeatures.html">WfsFeatures</a></li><li><a href="CpsiMapview.util.ColumnMenuOrderMixin.html">ColumnMenuOrderMixin</a></li><li><a href="CpsiMapview.util.EditWindowOpenerMixin.html">EditWindowOpenerMixin</a></li><li><a href="CpsiMapview.util.Layer.html">Layer</a></li><li><a href="CpsiMapview.util.LayerTreeFilter.html">LayerTreeFilter</a></li><li><a href="CpsiMapview.util.Legend.html">Legend</a></li><li><a href="CpsiMapview.util.RoleManager.html">RoleManager</a></li><li><a href="CpsiMapview.util.Style.html">Style</a></li><li><a href="CpsiMapview.util.SwitchLayer.html">SwitchLayer</a></li><li><a href="CpsiMapview.util.Tracing.html">Tracing</a></li><li><a href="CpsiMapview.util.Turf.html">Turf</a></li><li><a href="CpsiMapview.util.WmsFilter.html">WmsFilter</a></li><li><a href="CpsiMapview.util.ZoomerMixin.html">ZoomerMixin</a></li><li><a href="CpsiMapview.view.button.DigitizeButton.html">DigitizeButton</a></li><li><a href="CpsiMapview.view.button.DrawingButton.html">DrawingButton</a></li><li><a href="CpsiMapview.view.button.FeatureSelectionButton.html">FeatureSelectionButton</a></li><li><a href="CpsiMapview.view.button.HelpButton.html">HelpButton</a></li><li><a href="CpsiMapview.view.button.LoginButton.html">LoginButton</a></li><li><a href="CpsiMapview.view.button.MinimizeAllButton.html">MinimizeAllButton</a></li><li><a href="CpsiMapview.view.button.PermalinkButton.html">PermalinkButton</a></li><li><a href="CpsiMapview.view.button.SpatialQueryButton.html">SpatialQueryButton</a></li><li><a href="CpsiMapview.view.button.SplitByClickButton.html">SplitByClickButton</a></li><li><a href="CpsiMapview.view.button.StreetViewTool.html">StreetViewTool</a></li><li><a href="CpsiMapview.view.fileupload.FileGrid.html">FileGrid</a></li><li><a href="CpsiMapview.view.fileupload.FileGridController.html">FileGridController</a></li><li><a href="CpsiMapview.view.fileupload.FileUploadWindow.html">FileUploadWindow</a></li><li><a href="CpsiMapview.view.fileupload.FileUploadWindowController.html">FileUploadWindowController</a></li><li><a href="CpsiMapview.view.fileupload.Report.html">Report</a></li><li><a href="CpsiMapview.view.from.LayerTreeFilter.html">LayerTreeFilter</a></li><li><a href="CpsiMapview.view.grid.ItemDeleter.html">ItemDeleter</a></li><li><a href="CpsiMapview.view.menuitem.LayerFilterReset.html">LayerFilterReset</a></li><li><a href="CpsiMapview.view.menuitem.LayerGrid.html">LayerGrid</a></li><li><a href="CpsiMapview.view.menuitem.LayerHelp.html">LayerHelp</a></li><li><a href="CpsiMapview.view.menuitem.LayerLabels.html">LayerLabels</a></li><li><a href="CpsiMapview.view.menuitem.LayerMetadata.html">LayerMetadata</a></li><li><a href="CpsiMapview.view.menuitem.LayerOpacity.html">LayerOpacity</a></li><li><a href="CpsiMapview.view.menuitem.LayerRefresh.html">LayerRefresh</a></li><li><a href="CpsiMapview.view.menuitem.LayerStyleSwitcher.html">LayerStyleSwitcher</a></li><li><a href="CpsiMapview.view.panel.NumericAttributeSlider.html">NumericAttributeSlider</a></li><li><a href="CpsiMapview.view.toolbar.CircleSelectionToolbar.html">CircleSelectionToolbar</a></li><li><a href="CpsiMapview.view.toolbar.MinimizedWindows.html">MinimizedWindows</a></li><li><a href="CpsiMapview.view.toolbar.ParallelLineToolbar.html">ParallelLineToolbar</a></li><li><a href="CpsiMapview.view.window.MinimizableWindow.html">MinimizableWindow</a></li><li><a href="CpsiMapview.view.window.ParallelLineWindow.html">ParallelLineWindow</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:cmv-init-layersaddedFireswhenallinitiallayersfromtheconfighavebeencreatedandaddedtotheOLmap.">cmv-init-layersadded
Fires when all initial layers from the config have been created and added to the OL map.</a></li><li><a href="global.html#event:cmv-mapclickFireswhentheOLmapisclicked.">cmv-mapclick
Fires when the OL map is clicked.</a></li><li><a href="global.html#event:parallelLineCreatedFires,whenanewparallellinewascreated.">parallelLineCreated
Fires, when a new parallel line was created.</a></li></ul><h3>Global</h3><ul><li><a href="global.html#TemplatefunctioncalledbeforedoingtheGetFeatureInforequestReturnfalseifyoudon'twanttomaketheGetFeatureInforequest.">Template function called before doing the GetFeatureInfo request
Return false if you don't want to make the GetFeatureInfo request.</a></li><li><a href="global.html#beforeSave">beforeSave</a></li><li><a href="global.html#getErrors">getErrors</a></li><li><a href="global.html#onAfterSaveSucceded">onAfterSaveSucceded</a></li><li><a href="global.html#onChange">onChange</a></li><li><a href="global.html#onFocus">onFocus</a></li><li><a href="global.html#onGroupEditToggle">onGroupEditToggle</a></li><li><a href="global.html#rawToValue">rawToValue</a></li><li><a href="global.html#setValue">setValue</a></li><li><a href="global.html#storeConfig">storeConfig</a></li><li><a href="global.html#validate">validate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Jan 31 2025 08:59:07 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
